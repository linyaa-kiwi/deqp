#!/bin/bash

set -eu
set -o pipefail
shopt -s extglob

script_name="${BASH_SOURCE%%*/}"

if [[ "$#" -ne 1 ]]; then
    echo >&2 "usage: $script_name <commit>"
    exit 1
fi

commit="$1"

tree_status() {
    git status \
        --porcelain \
        --untracked-files=normal \
        --ignore-submodules=none \
        mustpass
}

tree_is_clean() {
    local n
    n="$(tree_status | wc -l)"
    [[ "$n" -eq 0 ]]
}


add_file() {
    local src="$1"
    local dst="mustpass/$commit/${1#external\/}"

    mkdir -p -- "$(dirname -- "$dst")"
    git cat-file -p "${commit}:${src}" > "$dst"
    git add -- "$dst"
}

add_tree() {
    local src_dir="$1"
    local dst_dir="mustpass/$commit/${1#external\/}"

    local src_tree
    src_tree="$(git rev-parse "${commit}:${src_dir}")"

    (
        # FIXME: Improve performance by using the default index
        local index0="index.0"
        export GIT_INDEX_FILE="$index0"
        git read-tree --empty
        git read-tree --prefix="$dst_dir" "$src_tree"
        git checkout-index -af
        rm -f "$index0"
    )

    git add "$dst_dir"
}

if ! tree_is_clean; then
    echo >&2 "error: ./mustpass is not clean"
    echo >&2 "git status:"
    tree_status >&2
    exit 1
fi

add_tree android/cts/master
add_tree external/vulkancts/mustpass

if tree_is_clean; then
    echo >&2 "skip: no changes"
    exit 0
fi

git commit --no-edit -m "Add '$commit'"
