#!/bin/bash

set -eu
set -o pipefail

script_name="${BASH_SOURCE%%*/}"

if [[ "$#" -ne 1 ]]; then
    echo >&2 "usage: $script_name <commit>"
    exit 1
fi

commit="$1"

tree_status() {
    git status \
        --porcelain \
        --untracked-files=normal \
        --ignore-submodules=none \
        mustpass
}

tree_is_clean() {
    local n
    n="$(tree_status | wc -l)"
    [[ "$n" -eq 0 ]]
}


add_file() {
    local src="$1"
    local dst="mustpass/$commit/${1#external\/}"

    mkdir -p -- "$(dirname -- "$dst")"
    git cat-file -p "${commit}:${src}" > "$dst"
    git add -- "$dst"
}

if ! tree_is_clean; then
    echo >&2 "error: ./mustpass is not clean"
    echo >&2 "git status:"
    tree_status >&2
    exit 1
fi

add_file external/vulkancts/mustpass/master/vk-default.txt
add_file android/cts/master/vk-master.txt
add_file external/vulkancts/mustpass/master/vk-default.txt
add_file android/cts/master/vk-master.txt

if tree_is_clean; then
    echo >&2 "skip: no changes"
    exit 0
fi

git commit --no-edit -m "Add '$commit'"
